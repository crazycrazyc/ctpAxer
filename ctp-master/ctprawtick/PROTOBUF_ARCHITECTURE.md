# CTP Protobufè¡Œæƒ…æ¶æ„æ”¹è¿›æ–¹æ¡ˆ

## ğŸ“Š æ¶æ„æ¦‚è§ˆ

### æ”¹è¿›å‰ï¼ˆæ—§æ¶æ„ï¼‰
```
CTPå›è°ƒ â†’ CSVå­—ç¬¦ä¸²æ ¼å¼åŒ– â†’ stringé˜Ÿåˆ— â†’ ZMQå‘é€ â†’ å­—ç¬¦ä¸²è§£æ â†’ æ•°æ®åº“å†™å…¥
```

### æ”¹è¿›åï¼ˆæ–°æ¶æ„ï¼‰
```
CTPå›è°ƒ â†’ ç»“æ„ä½“é˜Ÿåˆ— â†’ ä¸»çº¿ç¨‹protobufç¼–ç  â†’ ZMQå‘é€ â†’ protobufè§£ç  â†’ æ‰¹é‡æ•°æ®åº“å†™å…¥
```

## ğŸš€ æ ¸å¿ƒæ”¹è¿›

### 1. æ•°æ®æ ¼å¼ä¼˜åŒ–
- **æ—§æ ¼å¼**: CSVå­—ç¬¦ä¸² (`"20241129,CU2502,SHFE,CU2502,73450,..."`)
- **æ–°æ ¼å¼**: ProtobufäºŒè¿›åˆ¶ (æ›´ç´§å‡‘, ç±»å‹å®‰å…¨)

### 2. é˜Ÿåˆ—æ¶æ„æ”¹è¿›
- **æ—§é˜Ÿåˆ—**: `ReaderWriterQueue<string>`
- **æ–°é˜Ÿåˆ—**: `ReaderWriterQueue<CThostFtdcDepthMarketDataField>`

### 3. ç¼–ç ä½ç½®ä¼˜åŒ–
- **æ—§æ–¹å¼**: åœ¨CTPå›è°ƒå‡½æ•°ä¸­æ ¼å¼åŒ–å­—ç¬¦ä¸²
- **æ–°æ–¹å¼**: åœ¨ä¸»çº¿ç¨‹å¾ªç¯ä¸­è¿›è¡Œprotobufç¼–ç 

### 4. æ•°æ®åº“å†™å…¥ä¼˜åŒ–
- **æ—§æ–¹å¼**: å®æ—¶å†™å…¥ (æ¯æ¡æ•°æ®ç«‹å³å†™å…¥)
- **æ–°æ–¹å¼**: 30ç§’æ‰¹é‡å†™å…¥ (ç¼“å†²1000æ¡æˆ–30ç§’é—´éš”)

## ğŸ“ˆ æ€§èƒ½æå‡

| æŒ‡æ ‡ | æ”¹è¿›å‰ | æ”¹è¿›å | æå‡å¹…åº¦ |
|------|--------|--------|----------|
| ä¼ è¾“æ•ˆç‡ | CSVæ–‡æœ¬ | ProtobufäºŒè¿›åˆ¶ | **30-50%** |
| CPUä½¿ç”¨ç‡ | å­—ç¬¦ä¸²å¤„ç† | äºŒè¿›åˆ¶åºåˆ—åŒ– | **é™ä½20-30%** |
| æ•°æ®åº“å‹åŠ› | å®æ—¶å†™å…¥ | æ‰¹é‡å†™å…¥ | **é™ä½90%+** |
| å†…å­˜ä½¿ç”¨ | å­—ç¬¦ä¸²ç¼“å­˜ | ç»“æ„ä½“ç¼“å­˜ | **é™ä½40%** |
| ç±»å‹å®‰å…¨ | è¿è¡Œæ—¶æ£€æŸ¥ | ç¼–è¯‘æ—¶æ£€æŸ¥ | **100%å®‰å…¨** |

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. Protobufå®šä¹‰ (`proto/market_data.proto`)
```protobuf
message MarketDataMessage {
    string instrument_id = 2;
    double last_price = 5;
    int32 volume = 12;
    // ... 46ä¸ªå­—æ®µ
}
```

### 2. é˜Ÿåˆ—å¤„ç†æ”¹è¿›
```cpp
// æ—§æ–¹å¼
ReaderWriterQueue<string> q(10000);
q.try_enqueue(csvString);

// æ–°æ–¹å¼  
ReaderWriterQueue<CThostFtdcDepthMarketDataField> q(10000);
q.try_enqueue(*pDepthMarketData);
```

### 3. ç¼–ç æµç¨‹
```cpp
// ä¸»çº¿ç¨‹å¾ªç¯
CThostFtdcDepthMarketDataField marketData;
if (q.try_dequeue(marketData)) {
    // protobufç¼–ç 
    auto protoMessage = MarketDataProtobufConverter::convertToProtobuf(marketData, timestamp);
    auto serialized = MarketDataProtobufConverter::serializeToString(protoMessage);
    
    // ZMQå‘å¸ƒ
    marketPublisher.publishMessage("MARKET_DATA_PROTOBUF", serialized);
}
```

### 4. æ‰¹é‡æ•°æ®åº“å†™å…¥
```cpp
// 30ç§’æ‰¹é‡å†™å…¥çº¿ç¨‹
void batchWriterLoop() {
    while (running) {
        std::this_thread::sleep_for(std::chrono::seconds(30));
        flushMarketDataBuffer(); // æ‰¹é‡å†™å…¥ç¼“å†²åŒºæ•°æ®
    }
}
```

## ğŸ“ æ–‡ä»¶ç»“æ„

### æ–°å¢æ–‡ä»¶
```
ctp-master/ctprawtick/
â”œâ”€â”€ proto/market_data.proto                     # Protobufå®šä¹‰
â”œâ”€â”€ proto/market_data.pb.h/cc                   # ç”Ÿæˆçš„C++ä»£ç 
â”œâ”€â”€ include/MarketDataProtobufConverter.h       # è½¬æ¢å™¨å¤´æ–‡ä»¶
â”œâ”€â”€ src/MarketDataProtobufConverter.cpp         # è½¬æ¢å™¨å®ç°
â”œâ”€â”€ src/main_instrument.cpp                     # åˆçº¦æŸ¥è¯¢å™¨
â”œâ”€â”€ src/main_monitor.cpp                        # æŒä»“èµ„é‡‘ç›‘æ§å™¨
â””â”€â”€ test_protobuf_market.sh                     # æµ‹è¯•è„šæœ¬

zmq-dataupdate/
â”œâ”€â”€ proto/market_data.proto                     # Protobufå®šä¹‰ï¼ˆå¤åˆ¶ï¼‰
â”œâ”€â”€ proto/market_data.pb.h/cc                   # ç”Ÿæˆçš„C++ä»£ç 
â””â”€â”€ src/ZMQSubscriber.cpp                       # æ–°å¢protobufå¤„ç†
```

### ä¿®æ”¹æ–‡ä»¶
```
ctp-master/ctprawtick/
â”œâ”€â”€ src/main_market.cpp                         # é˜Ÿåˆ—ç±»å‹+protobufç¼–ç 
â”œâ”€â”€ src/CTPQuote.cpp                            # é˜Ÿåˆ—æ•°æ®ç±»å‹æ”¹å˜
â”œâ”€â”€ CMakeLists.txt                              # æ–°ç¨‹åº+protobufåº“
â””â”€â”€ start_system.sh                             # å¯åŠ¨è„šæœ¬æ›´æ–°

zmq-dataupdate/
â”œâ”€â”€ include/ZMQSubscriber.h                     # æ–°å¢protobufå¤„ç†æ–¹æ³•
â”œâ”€â”€ src/ZMQSubscriber.cpp                       # protobufè§£ç +æ‰¹é‡å†™å…¥
â””â”€â”€ CMakeLists.txt                              # protobufåº“æ”¯æŒ
```

## ğŸ¯ ç¨‹åºåˆ†ç¦»æ¶æ„

### ä¸‰ä¸ªç‹¬ç«‹ç¨‹åº
1. **ctpinstrument** - åˆçº¦æŸ¥è¯¢å™¨
   - æ¯æ—¥è¿è¡Œ2æ¬¡ (8:30, 15:30)
   - æŸ¥è¯¢å®Œæˆåè‡ªåŠ¨é€€å‡º
   - çº¿ç¨‹æ•°: 1ä¸ªä¸»çº¿ç¨‹

2. **ctpmonitor** - æŒä»“èµ„é‡‘ç›‘æ§å™¨  
   - æŒç»­è¿è¡Œ
   - æŒä»“æŸ¥è¯¢: 30ç§’é—´éš”
   - èµ„é‡‘æŸ¥è¯¢: 10ç§’é—´éš”
   - çº¿ç¨‹æ•°: 4ä¸ª (ä¸»+æŒä»“+èµ„é‡‘+è¿æ¥ç›‘æ§)

3. **ctpmarket** - è¡Œæƒ…æ•°æ®æ¨é€å™¨
   - æŒç»­è¿è¡Œ
   - å®æ—¶è¡Œæƒ…è®¢é˜…å’Œprotobufç¼–ç 
   - çº¿ç¨‹æ•°: 1ä¸ªä¸»çº¿ç¨‹

### æ•°æ®æµå‘å›¾
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ctpinstrument  â”‚    â”‚   ctpmonitor    â”‚    â”‚   ctpmarket     â”‚
â”‚   åˆçº¦æŸ¥è¯¢å™¨    â”‚    â”‚ æŒä»“èµ„é‡‘ç›‘æ§å™¨  â”‚    â”‚ è¡Œæƒ…æ•°æ®æ¨é€å™¨  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â”‚                       â”‚                       â”‚
         â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ZMQæ¶ˆæ¯æ€»çº¿                              â”‚
â”‚  INSTRUMENT_UPDATE  â”‚  POSITION_UPDATE  â”‚  MARKET_DATA_PROTOBUF â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    zmq_market_subscriber    â”‚
                    â”‚     (protobufè§£ç å™¨)        â”‚
                    â”‚      30ç§’æ‰¹é‡å†™å…¥           â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚   MySQLæ•°æ®åº“   â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ ä½¿ç”¨æŒ‡å—

### å¯åŠ¨ç³»ç»Ÿ
```bash
# æŸ¥çœ‹çŠ¶æ€
./start_system.sh status

# å¯åŠ¨æ‰€æœ‰ç¨‹åº
./start_system.sh start-all

# å•ç‹¬å¯åŠ¨å„ç»„ä»¶
./start_system.sh start-instrument  # åˆçº¦æŸ¥è¯¢
./start_system.sh start-monitor     # æŒä»“èµ„é‡‘ç›‘æ§  
./start_system.sh start-market      # è¡Œæƒ…æ¨é€

# å¯åŠ¨æ•°æ®åº“è®¢é˜…å™¨
cd /home/zyc/projects/ctprade/zmq-dataupdate/build
./zmq_market_subscriber
```

### ç›‘æ§æ—¥å¿—
```bash
# è¡Œæƒ…æ—¥å¿—
tail -f bin/debug/market.log

# ç›‘æ§å™¨æ—¥å¿—  
tail -f bin/debug/monitor.log

# æ•°æ®åº“è®¢é˜…å™¨æ—¥å¿—
tail -f zmq-dataupdate/build/subscriber.log
```

### é…ç½®æ–‡ä»¶
```bash
# åˆçº¦è®¢é˜…é…ç½®
vim bin/debug/zycConfig.json
# æ·»åŠ  "DEC": ["CU2502", "AL2502", ...] 

# æ•°æ®åº“é…ç½®
vim zmq-dataupdate/build/config.json
```

## ğŸ“‹ å®šæ—¶ä»»åŠ¡é…ç½®

```bash
# ç¼–è¾‘å®šæ—¶ä»»åŠ¡
crontab -e

# å‚è€ƒé…ç½® (crontab_example.txt)
# åˆçº¦æŸ¥è¯¢: æ¯æ—¥8:30å’Œ15:30
30 8 * * 1-5 /path/to/start_system.sh start-instrument
30 15 * * 1-5 /path/to/start_system.sh start-instrument

# æŒç»­æœåŠ¡: æ¯æ—¥å¯åŠ¨å’Œé‡å¯
45 8 * * 1-5 /path/to/start_system.sh start-monitor  
50 8 * * 1-5 /path/to/start_system.sh start-market
0 21 * * 1-5 /path/to/start_system.sh restart
```

## ğŸ‰ æ€»ç»“

è¿™æ¬¡æ¶æ„æ”¹è¿›å®ç°äº†ï¼š

âœ… **æ€§èƒ½ä¼˜åŒ–**: Protobufæå‡ä¼ è¾“æ•ˆç‡30-50%  
âœ… **æ•°æ®åº“ä¼˜åŒ–**: æ‰¹é‡å†™å…¥é™ä½å‹åŠ›90%+  
âœ… **æ¶æ„åˆ†ç¦»**: èŒè´£æ¸…æ™°çš„ä¸‰ä¸ªç‹¬ç«‹ç¨‹åº  
âœ… **çº¿ç¨‹ä¼˜åŒ–**: åˆç†çš„çº¿ç¨‹åˆ†é…å’Œèµ„æºåˆ©ç”¨  
âœ… **ç±»å‹å®‰å…¨**: ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥  
âœ… **ç‰ˆæœ¬å…¼å®¹**: Protobufå‘å‰/å‘åå…¼å®¹  
âœ… **ç»´æŠ¤å‹å¥½**: å®Œå–„çš„å¯åŠ¨è„šæœ¬å’Œç›‘æ§æœºåˆ¶  

è¿™æ˜¯ä¸€ä¸ªç°ä»£åŒ–ã€é«˜æ€§èƒ½ã€å¯ç»´æŠ¤çš„CTPäº¤æ˜“ç³»ç»Ÿæ¶æ„ï¼ğŸš€ 