# 📡 CTP实时行情功能使用指南

## 🚀 快速开始

### 1. 访问实时行情页面
在浏览器中打开：
```
http://localhost:5502/realtime
```

### 2. 系统状态确认
确保右上角连接状态显示为：**✅ 已连接**

### 3. 开始订阅行情
点击左侧控制面板中的 **"开始订阅"** 按钮

---

## 🎯 详细操作步骤

### 步骤一：打开实时行情页面

1. **确保服务运行**：
   ```bash
   ./start_realtime_system.sh status
   ```
   
2. **访问页面**：
   - 在浏览器中输入：`http://localhost:5502/realtime`
   - 或从主菜单点击：**实时行情**

3. **页面加载确认**：
   - 页面标题显示：**实时行情监控**
   - 右上角显示连接状态指示器

### 步骤二：了解界面布局

#### 🎨 页面结构
```
┌─────────────────────────────────────────────────────────────┐
│  [连接状态: ✅已连接]                                        │
├───────────────┬─────────────────────────────────────────────┤
│   侧边栏       │              主内容区域                      │
│               │                                           │
│ 📊 行情统计    │  🏆 系统状态面板                           │
│ 🎛️ 控制面板    │  📈 实时行情数据展示                         │
│               │  📋 系统日志                               │
└───────────────┴─────────────────────────────────────────────┘
```

#### 🎛️ 控制面板功能
- **开始订阅** - 开始接收实时行情数据
- **停止订阅** - 停止接收行情数据  
- **发送测试数据** - 发送模拟行情数据用于测试
- **清空数据** - 清除当前显示的行情数据

#### 📊 系统状态面板
- **收到消息数** - 累计接收的行情消息数量
- **活跃订阅者** - 当前WebSocket连接数
- **消息/秒** - 实时消息处理速率
- **运行时间** - 系统运行时长

### 步骤三：订阅实时行情

1. **点击"开始订阅"按钮**
   - 按钮变为灰色（已禁用）
   - "停止订阅"按钮变为可用
   - 系统日志显示："行情订阅成功"

2. **观察状态变化**
   - 活跃订阅者数量变为 1
   - 运行时间开始计时
   - 连接状态保持 "已连接"

3. **等待行情数据**
   - 如果有真实CTP行情：将显示实际交易数据
   - 如果没有真实行情：系统会发送示例数据

### 步骤四：查看行情数据

#### 📈 行情卡片信息
每个行情数据卡片显示：
```
┌─────────────────────────────┐
│ 📊 合约代码    [时间戳]     │
├─────────────────────────────┤
│ ¥3,000.50      +5.50 (+0.18%) │
│ 最新价         涨跌幅        │
├─────────────────────────────┤
│ 买:2,999.00  卖:3,001.00  量:1500 │
└─────────────────────────────┘
```

#### 🎨 颜色标识
- **🔴 红色边框** - 价格下跌
- **🟢 绿色边框** - 价格上涨  
- **🔵 蓝色边框** - 价格无变化

#### 📊 数据字段说明
- **合约代码** - 期货合约标识
- **最新价** - 当前最新成交价
- **买价/卖价** - 最优买入/卖出价格
- **成交量** - 累计成交数量
- **涨跌幅** - 相对开盘价的变化

---

## 🧪 测试功能

### 发送测试数据
1. **点击"发送测试数据"按钮**
2. **观察效果**：
   - 系统日志显示："测试数据发送成功"
   - 主区域出现模拟行情卡片
   - 收到消息数 +1

### 测试数据示例
```json
{
  "instrument_id": "TEST001",
  "last_price": 3003.96,
  "bid_price": 3003.46,
  "ask_price": 3004.46,
  "volume": 1526,
  "change": +3.96,
  "change_percent": +0.13
}
```

---

## 🎛️ 控制功能详解

### 开始订阅
- **功能**：开始接收实时行情数据
- **效果**：
  - 建立WebSocket连接到行情频道
  - 开始接收Redis消息队列数据
  - 启动行情数据显示

### 停止订阅  
- **功能**：停止接收行情数据
- **效果**：
  - 断开行情频道连接
  - 停止数据更新
  - 保留当前显示的数据

### 刷新状态
- **功能**：获取最新系统状态
- **显示信息**：
  - Redis连接状态
  - 当前订阅者数量
  - 行情监听器状态

### 清空数据
- **功能**：清除当前显示的所有行情数据
- **效果**：
  - 清空行情卡片显示
  - 重置为等待状态
  - 保持订阅连接

---

## 📊 监控信息

### 系统日志
实时显示系统运行状态：
- ✅ **成功消息**（绿色）- 正常操作
- ⚠️ **警告消息**（黄色）- 注意事项  
- ❌ **错误消息**（红色）- 异常情况
- ℹ️ **信息消息**（蓝色）- 一般信息

### 性能指标
- **消息处理速率** - 每秒处理的行情消息数
- **连接稳定性** - WebSocket连接状态
- **数据完整性** - 接收vs丢失消息比例

---

## 🛠️ 故障排除

### 常见问题及解决方案

#### 1. 页面无法打开
**症状**：浏览器显示无法连接
**解决方案**：
```bash
# 检查服务状态
./start_realtime_system.sh status

# 重启服务
./start_realtime_system.sh restart
```

#### 2. WebSocket连接失败
**症状**：右上角显示"连接错误"或"已断开"
**解决方案**：
- 刷新页面（F5）
- 检查防火墙设置
- 确认端口5502未被占用

#### 3. 点击"开始订阅"无反应
**症状**：按钮点击后无变化，日志无消息
**解决方案**：
- 打开浏览器开发者工具（F12）
- 查看控制台错误信息
- 检查网络连接

#### 4. 没有行情数据显示
**症状**：订阅成功但无数据卡片
**可能原因**：
- CTP行情服务未运行
- 没有真实行情数据
**解决方案**：
- 点击"发送测试数据"验证功能
- 检查CTP行情服务状态

#### 5. 数据显示异常
**症状**：行情数据格式错误或显示NaN
**解决方案**：
```bash
# 检查桥接服务日志
tail -f bridge.log

# 重启桥接服务
./start_realtime_system.sh restart
```

### 调试工具

#### 浏览器开发者工具
1. **打开方式**：按F12键
2. **查看控制台**：Console标签
3. **查看网络**：Network标签
4. **查看WebSocket**：WS连接状态

#### 服务端日志
```bash
# 查看WebSocket日志
tail -f websocket.log

# 查看桥接服务日志  
tail -f bridge.log

# 查看所有日志
./start_realtime_system.sh logs
```

---

## ⚙️ 高级配置

### 自定义显示
修改 `templates/realtime.html` 中的样式：
- 行情卡片颜色
- 数据字段显示
- 页面布局调整

### 数据过滤
修改 `market_bridge.py` 中的过滤逻辑：
- 合约筛选
- 价格范围过滤
- 数据频率控制

### 性能优化
```javascript
// 在 realtime.html 中调整更新频率
const UPDATE_INTERVAL = 100; // 毫秒
```

---

## 📈 最佳实践

### 1. 订阅管理
- **及时取消订阅**：离开页面前点击"停止订阅"
- **避免重复订阅**：一个浏览器标签页只订阅一次
- **监控连接状态**：注意右上角连接指示器

### 2. 数据查看
- **关注时间戳**：确认数据时效性
- **观察价格变化**：注意颜色指示
- **监控成交量**：判断市场活跃度

### 3. 性能优化
- **定期清空数据**：避免页面卡顿
- **关闭无用标签页**：减少资源占用
- **及时刷新页面**：清理内存使用

---

## 🎉 功能特色

### ✨ 实时性
- **毫秒级延迟**：WebSocket实时推送
- **自动更新**：无需手动刷新
- **状态同步**：多个指标实时更新

### 🎨 可视化
- **直观显示**：卡片式行情展示
- **颜色编码**：涨跌一目了然
- **动画效果**：数据变化提示

### 🛡️ 稳定性
- **自动重连**：连接断开自动恢复
- **错误处理**：异常情况友好提示
- **状态监控**：实时显示系统状态

### 📱 响应式
- **多设备支持**：手机、平板、电脑
- **自适应布局**：不同屏幕尺寸优化
- **触控友好**：移动设备操作便捷

---

**🎯 现在就开始体验实时行情功能吧！**
**访问地址：http://localhost:5502/realtime** 🚀 